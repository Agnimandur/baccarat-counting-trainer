<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baccarat Card Counting Trainer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 50%, #d1d8e0 100%);
            min-height: 100vh;
            color: #2d3436;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            color: #2d3436;
        }

        /* Start Panel */
        #start-panel {
            background: rgba(255,255,255,0.8);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .setting-group {
            margin-bottom: 25px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .setting-group input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .setting-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2d3436;
            cursor: pointer;
        }

        .value-display {
            text-align: center;
            font-size: 1.5rem;
            margin-top: 10px;
            color: #2d3436;
            font-weight: bold;
        }

        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .btn-start {
            background: #27ae60;
            color: #fff;
        }

        .btn-randomize {
            background: #636e72;
            color: #fff;
        }

        .btn-submit {
            background: #2d3436;
            color: #fff;
        }

        .btn-reset {
            background: #c0392b;
            color: #fff;
        }

        .running-count-display {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
        }

        .optimal-bet-display {
            margin-top: 10px;
            font-size: 1.1rem;
            color: #27ae60;
        }

        .optimal-bet-display span {
            font-weight: bold;
            font-size: 1.3rem;
        }

        /* Game Screen */
        #game-screen {
            display: none;
        }

        /* Bankroll Display */
        .bankroll-display {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.8);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .bankroll-item {
            font-size: 1.1rem;
        }

        .bankroll-item strong {
            color: #27ae60;
            font-size: 1.2rem;
        }

        /* Health Bar */
        .health-bar-container {
            background: rgba(255,255,255,0.8);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .health-bar-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .health-bar {
            height: 25px;
            background: #ddd;
            border-radius: 12px;
            overflow: hidden;
        }

        .health-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #2d3436, #636e72, #95a5a6);
            transition: width 0.5s ease;
            border-radius: 12px;
        }

        /* Timer */
        .timer-container {
            text-align: center;
            margin-bottom: 10px;
        }

        .timer {
            font-size: 3rem;
            font-weight: bold;
            color: #2d3436;
        }

        .timer.warning {
            color: #e67e22;
        }

        .timer.danger {
            color: #c0392b;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Baccarat Table */
        .baccarat-table {
            background: rgba(255,255,255,0.8);
            border-radius: 10px;
            padding: 10px 20px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            gap: 60px;
        }

        .hand-column {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .hand-label {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2d3436;
            margin-bottom: 5px;
        }

        /* Cards Display */
        .cards-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .card {
            width: 80px;
            height: 112px;
            border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .card img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Input Section */
        .input-section {
            text-align: center;
            margin-bottom: 5px;
        }

        .input-section label {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #636e72;
        }

        .input-explanation {
            font-size: 1rem;
            color: #636e72;
            margin-bottom: 20px;
            font-style: italic;
        }

        .input-row {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 5px;
        }

        .submit-box .btn-submit {
            height: 52px;
            padding: 0 30px;
        }

        .input-box {
            text-align: center;
        }

        .count-input {
            width: 140px;
            padding: 12px;
            font-size: 1.8rem;
            text-align: center;
            border: 3px solid #2d3436;
            border-radius: 10px;
            background: #fff;
            color: #2d3436;
            outline: none;
        }

        .count-input:focus {
            border-color: #636e72;
        }

        .count-input.correct {
            animation: flash-green 0.5s;
            border-color: #27ae60;
        }

        .count-input.incorrect {
            animation: flash-red 0.5s;
            border-color: #c0392b;
        }

        @keyframes flash-green {
            0%, 100% { background: rgba(39, 174, 96, 0.2); }
            50% { background: rgba(39, 174, 96, 0.4); }
        }

        @keyframes flash-red {
            0%, 100% { background: rgba(192, 57, 43, 0.2); }
            50% { background: rgba(192, 57, 43, 0.4); }
        }

        .result-display {
            margin-top: 5px;
            font-size: 1rem;
            min-height: 20px;
        }

        .result-display.correct {
            color: #27ae60;
        }

        .result-display.incorrect {
            color: #c0392b;
        }

        .optimal-bet-result {
            font-size: 1.1rem;
            font-weight: bold;
            color: #27ae60;
            margin: 5px 0;
            min-height: 20px;
        }

        /* Performance Tracking */
        .performance-section {
            background: rgba(255,255,255,0.8);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .performance-section h3 {
            margin-bottom: 15px;
            text-align: center;
        }

        .stats-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            text-align: center;
        }

        .stat-box {
            background: rgba(0,0,0,0.05);
            padding: 15px;
            border-radius: 8px;
            min-width: 100px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2d3436;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #636e72;
        }

        /* History Table */
        .history-section {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th,
        .history-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .history-table th {
            background: rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
        }

        /* Game Over */
        #game-over {
            display: none;
            text-align: center;
            padding: 40px;
        }

        #game-over h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .final-stats {
            margin: 30px 0;
        }

        .hint-text {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: 10px;
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: #fff;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #2d3436;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Counting System Inline */
        .counting-system {
            display: none;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 8px 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .counting-system.visible {
            display: block;
        }

        .coef-grid {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .coef-item {
            display: flex;
            align-items: center;
            gap: 4px;
            background: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .coef-card {
            font-size: 0.9rem;
            font-weight: bold;
            color: #000;
        }

        .coef-value {
            font-size: 0.9rem;
            font-weight: bold;
            color: #1e8449;
        }

        .coef-value.negative {
            color: #c0392b;
        }

        .coef-value.zero {
            color: #555;
        }

        .ob-formula {
            margin-top: 8px;
            text-align: center;
            font-size: 0.9rem;
            color: #2d3436;
            font-style: italic;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 1.5rem;
                margin-bottom: 20px;
            }

            /* Start Panel */
            #start-panel {
                padding: 20px 15px;
            }

            .setting-group label {
                font-size: 1rem;
            }

            .value-display {
                font-size: 1.2rem;
            }

            .button-group {
                flex-direction: column;
                gap: 10px;
            }

            .btn {
                width: 100%;
                padding: 12px 20px;
                font-size: 1rem;
            }

            .toggle-group {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .toggle-group label:first-child {
                font-size: 0.95rem;
            }

            .running-count-display {
                font-size: 0.95rem;
            }

            .optimal-bet-display {
                font-size: 1rem;
            }

            /* Game Screen */
            .bankroll-display {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .bankroll-item {
                font-size: 1rem;
            }

            .health-bar-label {
                flex-direction: column;
                gap: 5px;
                text-align: center;
            }

            .hint-text {
                font-size: 0.75rem;
            }

            .timer {
                font-size: 2.2rem;
            }

            /* Input Section */
            .input-row {
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }

            .input-box {
                width: 100%;
            }

            .input-box label {
                font-size: 0.95rem;
            }

            .count-input {
                width: 100%;
                max-width: 200px;
                font-size: 1.5rem;
                padding: 10px;
            }

            .submit-box {
                width: 100%;
            }

            .submit-box .btn-submit {
                width: 100%;
                max-width: 200px;
                height: auto;
                padding: 12px 20px;
            }

            .result-display {
                font-size: 0.9rem;
            }

            .optimal-bet-result {
                font-size: 1rem;
            }

            /* Baccarat Table */
            .baccarat-table {
                flex-direction: column;
                gap: 20px;
                padding: 15px 10px;
            }

            .hand-label {
                font-size: 1rem;
            }

            .cards-container {
                justify-content: center;
            }

            .card {
                width: 60px;
                height: 84px;
            }

            /* Counting System */
            .counting-system {
                padding: 10px;
            }

            .coef-grid {
                gap: 5px;
            }

            .coef-item {
                padding: 3px 6px;
            }

            .coef-card, .coef-value {
                font-size: 0.8rem;
            }

            .ob-formula {
                font-size: 0.8rem;
            }

            /* Performance Section */
            .performance-section {
                padding: 15px 10px;
                margin-top: 20px;
            }

            .performance-section h3 {
                font-size: 1.1rem;
            }

            .stats-grid {
                gap: 10px;
            }

            .stat-box {
                min-width: 70px;
                padding: 10px;
            }

            .stat-value {
                font-size: 1.3rem;
            }

            .stat-label {
                font-size: 0.75rem;
            }

            /* History Table */
            .history-section {
                max-height: 150px;
            }

            .history-table th,
            .history-table td {
                padding: 6px 4px;
                font-size: 0.75rem;
            }

            /* Game Over */
            #game-over {
                padding: 20px 15px;
            }

            #game-over h2 {
                font-size: 1.8rem;
            }

            #game-over p {
                font-size: 0.95rem;
            }

            .final-stats {
                margin: 20px 0;
            }
        }

        /* Extra small screens */
        @media (max-width: 400px) {
            h1 {
                font-size: 1.2rem;
            }

            .card {
                width: 50px;
                height: 70px;
            }

            .count-input {
                max-width: 160px;
                font-size: 1.3rem;
            }

            .stat-box {
                min-width: 60px;
                padding: 8px;
            }

            .stat-value {
                font-size: 1.1rem;
            }

            .stat-label {
                font-size: 0.7rem;
            }

            .coef-item {
                padding: 2px 4px;
            }

            .coef-card, .coef-value {
                font-size: 0.7rem;
            }

            .history-table th,
            .history-table td {
                padding: 4px 2px;
                font-size: 0.65rem;
            }

            .timer {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Baccarat Card Counting Trainer</h1>

        <!-- Start Panel -->
        <div id="start-panel">
            <div class="setting-group">
                <label>Cards Left in Deck</label>
                <div class="value-display" id="cards-left-display">416</div>
            </div>

            <div class="setting-group">
                <label>Decision Time (seconds)</label>
                <input type="range" id="decision-time" min="10" max="60" value="30">
                <div class="value-display" id="decision-time-display">30</div>
            </div>

            <div class="setting-group">
                <label>Bankroll (USD)</label>
                <input type="range" id="bankroll" min="10000" max="200000" step="5000" value="50000">
                <div class="value-display" id="bankroll-display">$50,000</div>
            </div>

            <div class="running-count-display">
                <label>Starting Running Count: <span id="running-count-display">0</span> (TC: <span id="true-count-display">0.00</span>)</label>
                <div class="optimal-bet-display">Optimal Bet: <span id="optimal-bet-display">$0</span></div>
            </div>

            <div class="toggle-group">
                <label>Show Counting System (toggle with F key)</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="show-counting-toggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="toggle-group">
                <label>Test Optimal Bet</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="test-optimal-bet-toggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="toggle-group">
                <label>Competitive Mode</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="competitive-mode-toggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="button-group">
                <button class="btn btn-reset" onclick="resetSettings()">Reset</button>
                <button class="btn btn-randomize" onclick="randomize()">Randomize</button>
                <button class="btn btn-start" onclick="startGame()">Start</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen">
            <!-- Bankroll Display -->
            <div class="bankroll-display">
                <span class="bankroll-item">Bankroll: <strong id="game-bankroll">$50,000</strong></span>
                <span class="bankroll-item" id="dragon7-result"></span>
            </div>

            <!-- Health Bar -->
            <div class="health-bar-container">
                <div class="health-bar-label">
                    <span>Decks Remaining: <strong id="decks-remaining-text">8.00</strong></span>
                    <span class="hint-text">SPACE: Submit | P: Pause | Q: Quit | F: Toggle Cheatsheet</span>
                </div>
                <div class="health-bar">
                    <div class="health-bar-fill" id="health-bar-fill" style="width: 100%"></div>
                </div>
            </div>

            <!-- Timer -->
            <div class="timer-container">
                <div class="timer" id="timer">15</div>
            </div>

            <!-- Input -->
            <div class="input-section">
                <div class="input-row">
                    <div class="input-box">
                        <label>Running Count (exact)</label>
                        <input type="number" class="count-input" id="running-count-input" step="1">
                        <div class="result-display" id="rc-result"></div>
                    </div>
                    <div class="input-box">
                        <label>True Count (within 1)</label>
                        <input type="number" class="count-input" id="true-count-input" step="0.1">
                        <div class="result-display" id="tc-result"></div>
                    </div>
                    <div class="input-box" id="optimal-bet-input-box" style="display: none;">
                        <label>Optimal Bet (within $10)</label>
                        <input type="number" class="count-input" id="optimal-bet-input" step="1">
                        <div class="result-display" id="ob-result"></div>
                    </div>
                    <div class="input-box submit-box">
                        <label>&nbsp;</label>
                        <button class="btn btn-submit" onclick="submitGuess()">Submit</button>
                    </div>
                </div>
                <div class="optimal-bet-result" id="optimal-bet-result"></div>
            </div>

            <!-- Cards -->
            <div class="baccarat-table">
                <div class="hand-column">
                    <span class="hand-label">Player</span>
                    <div class="cards-container" id="player-cards"></div>
                </div>
                <div class="hand-column">
                    <span class="hand-label">Banker</span>
                    <div class="cards-container" id="banker-cards"></div>
                </div>
            </div>

            <!-- Counting System Inline -->
            <div class="counting-system" id="counting-system">
                <div class="coef-grid">
                    <div class="coef-item"><span class="coef-card">0:</span><span class="coef-value">+3</span></div>
                    <div class="coef-item"><span class="coef-card">1:</span><span class="coef-value zero">0</span></div>
                    <div class="coef-item"><span class="coef-card">2:</span><span class="coef-value zero">0</span></div>
                    <div class="coef-item"><span class="coef-card">3:</span><span class="coef-value negative">-4</span></div>
                    <div class="coef-item"><span class="coef-card">4:</span><span class="coef-value negative">-12</span></div>
                    <div class="coef-item"><span class="coef-card">5:</span><span class="coef-value negative">-14</span></div>
                    <div class="coef-item"><span class="coef-card">6:</span><span class="coef-value negative">-16</span></div>
                    <div class="coef-item"><span class="coef-card">7:</span><span class="coef-value negative">-20</span></div>
                    <div class="coef-item"><span class="coef-card">8:</span><span class="coef-value">+28</span></div>
                    <div class="coef-item"><span class="coef-card">9:</span><span class="coef-value">+26</span></div>
                </div>
                <div class="ob-formula" id="ob-formula" style="display: none;">Optimal Bet = <span id="ob-coef1">1.75</span> × TC − <span id="ob-coef2">80</span></div>
            </div>

            <!-- Performance -->
            <div class="performance-section">
                <h3>Performance</h3>
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="rounds-played">0</div>
                        <div class="stat-label">Rounds</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="rc-accuracy">0%</div>
                        <div class="stat-label">RC Accuracy</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="tc-accuracy">0%</div>
                        <div class="stat-label">TC Accuracy</div>
                    </div>
                    <div class="stat-box" id="ob-accuracy-box" style="display: none;">
                        <div class="stat-value" id="ob-accuracy">0%</div>
                        <div class="stat-label">OB Accuracy</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avg-time">0s</div>
                        <div class="stat-label">Avg Time</div>
                    </div>
                </div>

                <div class="history-section">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Round</th>
                                <th>RC Guess</th>
                                <th>RC Actual</th>
                                <th>TC Guess</th>
                                <th>TC Actual</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="history-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Game Over -->
        <div id="game-over">
            <h2>Game Over!</h2>
            <p>Not enough cards remaining to continue.</p>
            <div class="final-stats">
                <div class="stats-grid" id="final-stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="final-rounds">0</div>
                        <div class="stat-label">Total Rounds</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="final-rc-accuracy">0%</div>
                        <div class="stat-label">RC Accuracy</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="final-tc-accuracy">0%</div>
                        <div class="stat-label">TC Accuracy</div>
                    </div>
                    <div class="stat-box" id="final-ob-accuracy-box" style="display: none;">
                        <div class="stat-value" id="final-ob-accuracy">0%</div>
                        <div class="stat-label">OB Accuracy</div>
                    </div>
                    <div class="stat-box" id="final-rc-error-box" style="display: none;">
                        <div class="stat-value" id="final-rc-error">0</div>
                        <div class="stat-label">Avg RC Error</div>
                    </div>
                    <div class="stat-box" id="final-tc-error-box" style="display: none;">
                        <div class="stat-value" id="final-tc-error">0</div>
                        <div class="stat-label">Avg TC Error</div>
                    </div>
                    <div class="stat-box" id="final-ob-error-box" style="display: none;">
                        <div class="stat-value" id="final-ob-error">$0</div>
                        <div class="stat-label">Avg OB Error</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="final-avg-time">0s</div>
                        <div class="stat-label">Avg Response Time</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="final-bankroll">$0</div>
                        <div class="stat-label">Final Bankroll</div>
                    </div>
                </div>
            </div>
            <button class="btn btn-start" onclick="resetGame()">Play Again</button>
            <p class="hint-text" style="margin-top: 15px;">Press Q to return to start</p>
        </div>
    </div>

    <script>
        // Coefficients for card counting
        // Index maps to baccarat value: 0=10/J/Q/K, 1=A, 2=2, ..., 9=9
        const COEFS = [3.0, 0.0, 0.0, -4.0, -12.0, -14.0, -16.0, -20.0, 28.0, 26.0];

        // Card suits and values
        const SUITS = ['♠', '♥', '♦', '♣'];
        const VALUES = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

        // Game state
        let deck = [];
        let runningCount = 0;
        let originalRunningCount = 0;
        let cardsLeftSetting = 416;
        let decisionTime = 30;
        let bankroll = 50000;
        let timerInterval = null;
        let currentTime = 0;
        let roundStartTime = 0;
        let isPaused = false;
        let pauseStartTime = 0;
        let totalPausedTime = 0;
        let playerCards = [];
        let bankerCards = [];
        let actualTrueCount = 0;

        // Performance tracking
        let roundsPlayed = 0;
        let rcCorrectGuesses = 0;
        let tcCorrectGuesses = 0;
        let obCorrectGuesses = 0;
        let totalTime = 0;
        let history = [];
        let hasSubmitted = false;
        let actualRunningCount = 0;
        let actualOptimalBet = 0;
        let currentBankroll = 50000;
        let testOptimalBet = false;
        let competitiveMode = false;
        let rcTotalError = 0;
        let tcTotalError = 0;
        let obTotalError = 0;

        // Initialize inputs
        document.getElementById('decision-time').addEventListener('input', function() {
            decisionTime = parseInt(this.value);
            document.getElementById('decision-time-display').textContent = this.value;
        });

        document.getElementById('bankroll').addEventListener('input', function() {
            bankroll = parseInt(this.value);
            document.getElementById('bankroll-display').textContent = '$' + bankroll.toLocaleString();
            updateOptimalBet();
        });

        // Calculate and display optimal bet
        function updateOptimalBet() {
            const remainingDecks = cardsLeftSetting / 52;
            const trueCount = remainingDecks > 0 ? runningCount / remainingDecks : 0;

            // Scale factor based on bankroll (base is 50k)
            const scale = bankroll / 50000;

            // Optimal bet = max(0, scale * (1.75 * TC - 80))
            const optimalBet = Math.max(0, scale * (1.75 * trueCount - 80));

            document.getElementById('optimal-bet-display').textContent = '$' + Math.round(optimalBet).toLocaleString();
        }

        // Create a fresh 8-deck shoe
        function createFullDeck() {
            const deck = [];
            for (let d = 0; d < 8; d++) {
                for (const suit of SUITS) {
                    for (let i = 0; i < VALUES.length; i++) {
                        deck.push({
                            suit: suit,
                            value: VALUES[i],
                            baccaratValue: getBaccaratValue(i)
                        });
                    }
                }
            }
            return deck;
        }

        // Get baccarat value (0-9)
        // A=1, 2=2, ..., 9=9, 10/J/Q/K=0
        function getBaccaratValue(index) {
            if (index === 0) return 1; // Ace = 1
            if (index >= 1 && index <= 8) return index + 1; // 2-9 (index 1-8 -> value 2-9)
            return 0; // 10, J, Q, K = 0
        }

        // Shuffle deck
        function shuffleDeck(deck) {
            const shuffled = [...deck];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Calculate baccarat hand total (mod 10)
        function handTotal(cards) {
            let total = 0;
            for (const card of cards) {
                total += card.baccaratValue;
            }
            return total % 10;
        }

        // Deal a baccarat hand according to official rules
        function dealBaccaratHand() {
            playerCards = [];
            bankerCards = [];

            // Initial deal: Player card, Banker card, Player card, Banker card
            playerCards.push(deck.pop());
            bankerCards.push(deck.pop());
            playerCards.push(deck.pop());
            bankerCards.push(deck.pop());

            const playerInitial = handTotal(playerCards);
            const bankerInitial = handTotal(bankerCards);

            // Check for naturals (8 or 9)
            if (playerInitial >= 8 || bankerInitial >= 8) {
                // Natural - no more cards drawn
                return;
            }

            // Player's rule
            let playerThirdCard = null;
            if (playerInitial <= 5) {
                // Player draws
                playerThirdCard = deck.pop();
                playerCards.push(playerThirdCard);
            }

            // Banker's rule
            if (playerThirdCard === null) {
                // Player stood - banker uses simple rule
                if (bankerInitial <= 5) {
                    bankerCards.push(deck.pop());
                }
            } else {
                // Player drew - banker uses complex rules
                const playerThirdValue = playerThirdCard.baccaratValue;

                if (bankerInitial <= 2) {
                    // Always draw
                    bankerCards.push(deck.pop());
                } else if (bankerInitial === 3) {
                    // Draw unless player's third is 8
                    if (playerThirdValue !== 8) {
                        bankerCards.push(deck.pop());
                    }
                } else if (bankerInitial === 4) {
                    // Draw if player's third is 2-7
                    if (playerThirdValue >= 2 && playerThirdValue <= 7) {
                        bankerCards.push(deck.pop());
                    }
                } else if (bankerInitial === 5) {
                    // Draw if player's third is 4-7
                    if (playerThirdValue >= 4 && playerThirdValue <= 7) {
                        bankerCards.push(deck.pop());
                    }
                } else if (bankerInitial === 6) {
                    // Draw if player's third is 6 or 7
                    if (playerThirdValue === 6 || playerThirdValue === 7) {
                        bankerCards.push(deck.pop());
                    }
                }
                // If bankerInitial === 7, banker stands (no action needed)
            }
        }

        // Randomize function
        function randomize() {
            // Random cards left between 24 and 416
            cardsLeftSetting = Math.floor(Math.random() * (416 - 24 + 1)) + 24;

            const fullDeck = createFullDeck();
            const shuffled = shuffleDeck(fullDeck);

            // Remove cards until we have cardsLeftSetting remaining
            const cardsToRemove = 416 - cardsLeftSetting;
            const removedCards = shuffled.slice(0, cardsToRemove);
            deck = shuffled.slice(cardsToRemove);

            // Calculate running count from removed cards
            originalRunningCount = 0;
            for (const card of removedCards) {
                originalRunningCount += COEFS[card.baccaratValue];
            }

            runningCount = originalRunningCount;

            // Update displays
            document.getElementById('cards-left-display').textContent = cardsLeftSetting;
            document.getElementById('running-count-display').textContent = originalRunningCount.toFixed(1);
            updateStartingTrueCount();
        }

        // Reset settings to defaults
        function resetSettings() {
            // Reset cards left
            cardsLeftSetting = 416;
            deck = [];
            runningCount = 0;
            originalRunningCount = 0;
            document.getElementById('cards-left-display').textContent = '416';
            document.getElementById('running-count-display').textContent = '0';

            // Reset decision time
            decisionTime = 30;
            document.getElementById('decision-time').value = 30;
            document.getElementById('decision-time-display').textContent = '30';

            // Reset bankroll
            bankroll = 50000;
            document.getElementById('bankroll').value = 50000;
            document.getElementById('bankroll-display').textContent = '$50,000';

            // Reset toggles
            document.getElementById('show-counting-toggle').checked = false;
            document.getElementById('test-optimal-bet-toggle').checked = false;
            document.getElementById('competitive-mode-toggle').checked = false;

            // Update true count and optimal bet displays
            updateStartingTrueCount();
        }

        // Update starting true count display
        function updateStartingTrueCount() {
            const remainingDecks = cardsLeftSetting / 52;
            const trueCount = remainingDecks > 0 ? runningCount / remainingDecks : 0;
            document.getElementById('true-count-display').textContent = trueCount.toFixed(2);
            updateOptimalBet();
        }

        // Start game
        function startGame() {
            // If not randomized, create fresh deck
            if (deck.length === 0 || deck.length !== cardsLeftSetting) {
                deck = createFullDeck();
                deck = shuffleDeck(deck);
                // Trim to cardsLeftSetting
                if (cardsLeftSetting < 416) {
                    const cardsToRemove = 416 - cardsLeftSetting;
                    const removedCards = deck.slice(0, cardsToRemove);
                    deck = deck.slice(cardsToRemove);

                    // Calculate running count from removed cards
                    originalRunningCount = 0;
                    for (const card of removedCards) {
                        originalRunningCount += COEFS[card.baccaratValue];
                    }
                    runningCount = originalRunningCount;
                } else {
                    runningCount = 0;
                    originalRunningCount = 0;
                }
            }

            // Reset performance
            roundsPlayed = 0;
            rcCorrectGuesses = 0;
            tcCorrectGuesses = 0;
            obCorrectGuesses = 0;
            rcTotalError = 0;
            tcTotalError = 0;
            obTotalError = 0;
            totalTime = 0;
            currentBankroll = bankroll;
            history = [];

            // Check if testing optimal bet and competitive mode
            testOptimalBet = document.getElementById('test-optimal-bet-toggle').checked;
            competitiveMode = document.getElementById('competitive-mode-toggle').checked;

            document.getElementById('start-panel').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            document.getElementById('game-over').style.display = 'none';
            document.querySelector('h1').style.display = 'none';

            // Update bankroll display
            document.getElementById('game-bankroll').textContent = '$' + currentBankroll.toLocaleString();
            document.getElementById('dragon7-result').textContent = '';

            // Show/hide optimal bet input and accuracy boxes
            document.getElementById('optimal-bet-input-box').style.display = testOptimalBet ? 'block' : 'none';
            document.getElementById('ob-accuracy-box').style.display = testOptimalBet ? 'block' : 'none';
            document.getElementById('final-ob-accuracy-box').style.display = testOptimalBet ? 'block' : 'none';

            // Set initial counting system visibility based on toggle
            const showCounting = document.getElementById('show-counting-toggle').checked;
            const countingSystem = document.getElementById('counting-system');
            const obFormula = document.getElementById('ob-formula');

            // Update OB formula coefficients based on bankroll
            const scale = bankroll / 50000;
            document.getElementById('ob-coef1').textContent = (1.75 * scale).toFixed(2);
            document.getElementById('ob-coef2').textContent = (80 * scale).toFixed(0);

            if (showCounting) {
                countingSystem.classList.add('visible');
                obFormula.style.display = testOptimalBet ? 'block' : 'none';
            } else {
                countingSystem.classList.remove('visible');
            }

            // Update hint text based on competitive mode
            const hintText = document.querySelector('.hint-text');
            if (competitiveMode) {
                hintText.textContent = 'SPACE: Submit | P: Pause | Q: Quit | Z: End Game | F: Toggle Cheatsheet';
            } else {
                hintText.textContent = 'SPACE: Submit | P: Pause | Q: Quit | F: Toggle Cheatsheet';
            }

            updatePerformanceDisplay();
            dealNextHand();
        }

        // Deal next hand
        function dealNextHand() {
            // Need at least 6 cards for a full baccarat hand
            if (deck.length < 6) {
                endGame();
                return;
            }

            hasSubmitted = false;
            isPaused = false;
            totalPausedTime = 0;

            // Deal baccarat hand according to rules
            dealBaccaratHand();

            // Combine all dealt cards for counting
            const allDealtCards = [...playerCards, ...bankerCards];

            // Update running count
            for (const card of allDealtCards) {
                runningCount += COEFS[card.baccaratValue];
            }

            // Store actual counts
            actualRunningCount = runningCount;
            const remainingDecks = deck.length / 52;
            actualTrueCount = runningCount / remainingDecks;

            // Calculate optimal bet
            const scale = bankroll / 50000;
            actualOptimalBet = Math.max(0, Math.round(scale * (1.75 * actualTrueCount - 80)));

            // Update UI
            updateHealthBar();
            displayCards();

            // Reset inputs
            const rcInput = document.getElementById('running-count-input');
            const tcInput = document.getElementById('true-count-input');
            const obInput = document.getElementById('optimal-bet-input');
            rcInput.value = '';
            tcInput.value = '';
            obInput.value = '';
            rcInput.className = 'count-input';
            tcInput.className = 'count-input';
            obInput.className = 'count-input';
            rcInput.focus();
            document.getElementById('rc-result').textContent = '';
            document.getElementById('tc-result').textContent = '';
            document.getElementById('ob-result').textContent = '';
            document.getElementById('optimal-bet-result').textContent = '';
            document.getElementById('dragon7-result').textContent = '';

            // Start timer
            roundStartTime = Date.now();
            currentTime = decisionTime;
            updateTimer();

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                currentTime--;
                updateTimer();
                if (currentTime <= 0) {
                    submitGuess(true);
                }
            }, 1000);
        }

        // Update health bar
        function updateHealthBar() {
            const percentage = (deck.length / 416) * 100;
            const decksRemaining = deck.length / 52;
            document.getElementById('health-bar-fill').style.width = percentage + '%';
            document.getElementById('decks-remaining-text').textContent = decksRemaining.toFixed(2);
        }

        // Map card values to image filenames
        function getCardImagePath(value) {
            const valueMap = {
                'A': 'ace_of_spades.png',
                '2': '2_of_spades.png',
                '3': '3_of_spades.png',
                '4': '4_of_spades.png',
                '5': '5_of_spades.png',
                '6': '6_of_spades.png',
                '7': '7_of_spades.png',
                '8': '8_of_spades.png',
                '9': '9_of_spades.png',
                '10': '10_of_spades.png',
                'J': 'jack_of_spades.png',
                'Q': 'queen_of_spades.png',
                'K': 'king_of_spades.png'
            };
            return 'cards/' + valueMap[value];
        }

        // Display cards in Player and Banker rows
        function displayCards() {
            const playerContainer = document.getElementById('player-cards');
            const bankerContainer = document.getElementById('banker-cards');
            playerContainer.innerHTML = '';
            bankerContainer.innerHTML = '';

            for (const card of playerCards) {
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                const img = document.createElement('img');
                img.src = getCardImagePath(card.value);
                img.alt = card.value;
                cardEl.appendChild(img);
                playerContainer.appendChild(cardEl);
            }

            for (const card of bankerCards) {
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                const img = document.createElement('img');
                img.src = getCardImagePath(card.value);
                img.alt = card.value;
                cardEl.appendChild(img);
                bankerContainer.appendChild(cardEl);
            }
        }

        // Update timer display
        function updateTimer() {
            const timerEl = document.getElementById('timer');
            timerEl.textContent = currentTime;
            timerEl.className = 'timer';

            if (currentTime <= 3) {
                timerEl.classList.add('danger');
            } else if (currentTime <= 5) {
                timerEl.classList.add('warning');
            }
        }

        // Submit guess
        function submitGuess(timeout = false) {
            if (hasSubmitted) return;
            hasSubmitted = true;

            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            const rcInput = document.getElementById('running-count-input');
            const tcInput = document.getElementById('true-count-input');
            const obInput = document.getElementById('optimal-bet-input');

            const rcValue = rcInput.value.trim();
            const tcValue = tcInput.value.trim();
            const obValue = obInput.value.trim();

            const rcIsBlank = rcValue === '';
            const tcIsBlank = tcValue === '';
            const obIsBlank = obValue === '';

            const rcGuess = rcIsBlank ? null : parseInt(rcValue);
            const tcGuess = tcIsBlank ? null : parseFloat(tcValue);
            const obGuess = obIsBlank ? null : parseInt(obValue);

            const timeTaken = (Date.now() - roundStartTime - totalPausedTime) / 1000;

            // Check RC accuracy (exact match for integers)
            const rcCorrect = !rcIsBlank && !isNaN(rcGuess) && rcGuess === Math.round(actualRunningCount);

            // Check TC accuracy (within 1)
            const tcCorrect = !tcIsBlank && !isNaN(tcGuess) && Math.abs(tcGuess - actualTrueCount) <= 1;

            // Check OB accuracy (within $10) - only if testing
            const obCorrect = testOptimalBet && !obIsBlank && !isNaN(obGuess) && Math.abs(obGuess - actualOptimalBet) <= 10;

            // Calculate absolute errors for competitive mode
            const rcError = rcIsBlank || isNaN(rcGuess) ? Math.abs(Math.round(actualRunningCount)) : Math.abs(rcGuess - Math.round(actualRunningCount));
            const tcError = tcIsBlank || isNaN(tcGuess) ? Math.abs(actualTrueCount) : Math.abs(tcGuess - actualTrueCount);
            const obError = testOptimalBet ? (obIsBlank || isNaN(obGuess) ? actualOptimalBet : Math.abs(obGuess - actualOptimalBet)) : 0;

            // Track total errors
            rcTotalError += rcError;
            tcTotalError += tcError;
            obTotalError += obError;

            // Update UI - hide actual values in competitive mode
            const rcResultEl = document.getElementById('rc-result');
            const tcResultEl = document.getElementById('tc-result');

            if (competitiveMode) {
                // In competitive mode, don't show actual values or correct/incorrect styling
                rcInput.className = 'count-input';
                tcInput.className = 'count-input';
                rcResultEl.textContent = 'Submitted';
                rcResultEl.className = 'result-display';
                tcResultEl.textContent = 'Submitted';
                tcResultEl.className = 'result-display';

                if (testOptimalBet) {
                    obInput.className = 'count-input';
                    const obResultEl = document.getElementById('ob-result');
                    obResultEl.textContent = 'Submitted';
                    obResultEl.className = 'result-display';
                }

                // Don't show optimal bet result in competitive mode
                document.getElementById('optimal-bet-result').textContent = '';
            } else {
                // Normal mode - show actual values
                rcInput.className = `count-input ${rcCorrect ? 'correct' : 'incorrect'}`;
                tcInput.className = `count-input ${tcCorrect ? 'correct' : 'incorrect'}`;

                rcResultEl.textContent = `Actual: ${Math.round(actualRunningCount)}`;
                rcResultEl.className = `result-display ${rcCorrect ? 'correct' : 'incorrect'}`;

                tcResultEl.textContent = `Actual: ${actualTrueCount.toFixed(2)}`;
                tcResultEl.className = `result-display ${tcCorrect ? 'correct' : 'incorrect'}`;

                // Update optimal bet UI
                if (testOptimalBet) {
                    obInput.className = `count-input ${obCorrect ? 'correct' : 'incorrect'}`;
                    const obResultEl = document.getElementById('ob-result');
                    obResultEl.textContent = `Actual: $${actualOptimalBet.toLocaleString()}`;
                    obResultEl.className = `result-display ${obCorrect ? 'correct' : 'incorrect'}`;
                }

                // Show optimal bet result in normal mode
                document.getElementById('optimal-bet-result').textContent = `Optimal Bet: $${actualOptimalBet.toLocaleString()}`;
            }

            // Calculate Dragon 7 sidebet result
            const playerTotal = handTotal(playerCards);
            const bankerTotal = handTotal(bankerCards);
            const bankerWins = bankerTotal > playerTotal;
            const isDragon7 = bankerWins && bankerCards.length === 3 && bankerTotal === 7;

            // Calculate Dragon 7 result (always update bankroll internally)
            if (isDragon7) {
                // Dragon 7 wins! 40:1 payout
                const winnings = 40 * actualOptimalBet;
                currentBankroll += winnings;
                if (!competitiveMode) {
                    document.getElementById('dragon7-result').style.color = '#27ae60';
                    document.getElementById('dragon7-result').innerHTML = `<strong>DRAGON 7! +$${winnings.toLocaleString()}</strong>`;
                }
            } else {
                // Lose the bet
                currentBankroll -= actualOptimalBet;
                if (!competitiveMode) {
                    document.getElementById('dragon7-result').style.color = '#c0392b';
                    document.getElementById('dragon7-result').innerHTML = `<strong>-$${actualOptimalBet.toLocaleString()}</strong>`;
                }
            }

            // In competitive mode, hide bet results and bankroll changes
            if (competitiveMode) {
                document.getElementById('dragon7-result').textContent = '';
                document.getElementById('game-bankroll').textContent = '—';
            } else {
                document.getElementById('game-bankroll').textContent = '$' + currentBankroll.toLocaleString();
            }

            // Update performance
            roundsPlayed++;
            if (rcCorrect) rcCorrectGuesses++;
            if (tcCorrect) tcCorrectGuesses++;
            if (testOptimalBet && obCorrect) obCorrectGuesses++;
            totalTime += timeTaken;

            history.push({
                round: roundsPlayed,
                rcGuess: rcIsBlank ? '—' : rcGuess,
                rcActual: Math.round(actualRunningCount),
                tcGuess: tcIsBlank ? '—' : tcGuess.toFixed(2),
                tcActual: actualTrueCount.toFixed(2),
                time: timeTaken.toFixed(1)
            });

            updatePerformanceDisplay();

            // Deal next hand after delay
            setTimeout(() => {
                dealNextHand();
            }, 2000);
        }

        // Update performance display
        function updatePerformanceDisplay() {
            document.getElementById('rounds-played').textContent = roundsPlayed;

            if (competitiveMode) {
                // In competitive mode, hide accuracy stats during game
                document.getElementById('rc-accuracy').textContent = '—';
                document.getElementById('tc-accuracy').textContent = '—';
                if (testOptimalBet) {
                    document.getElementById('ob-accuracy').textContent = '—';
                }
            } else {
                const rcAccuracy = roundsPlayed > 0 ? (rcCorrectGuesses / roundsPlayed * 100).toFixed(0) : 0;
                document.getElementById('rc-accuracy').textContent = rcAccuracy + '%';

                const tcAccuracy = roundsPlayed > 0 ? (tcCorrectGuesses / roundsPlayed * 100).toFixed(0) : 0;
                document.getElementById('tc-accuracy').textContent = tcAccuracy + '%';

                if (testOptimalBet) {
                    const obAccuracy = roundsPlayed > 0 ? (obCorrectGuesses / roundsPlayed * 100).toFixed(0) : 0;
                    document.getElementById('ob-accuracy').textContent = obAccuracy + '%';
                }
            }

            const avgTime = roundsPlayed > 0 ? (totalTime / roundsPlayed).toFixed(1) : 0;
            document.getElementById('avg-time').textContent = avgTime + 's';

            // Update history table - hide actual values in competitive mode
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = '';

            for (const entry of history.slice().reverse()) {
                const row = document.createElement('tr');
                if (competitiveMode) {
                    row.innerHTML = `
                        <td>${entry.round}</td>
                        <td>${entry.rcGuess}</td>
                        <td>—</td>
                        <td>${entry.tcGuess}</td>
                        <td>—</td>
                        <td>${entry.time}s</td>
                    `;
                } else {
                    row.innerHTML = `
                        <td>${entry.round}</td>
                        <td>${entry.rcGuess}</td>
                        <td>${entry.rcActual}</td>
                        <td>${entry.tcGuess}</td>
                        <td>${entry.tcActual}</td>
                        <td>${entry.time}s</td>
                    `;
                }
                tbody.appendChild(row);
            }
        }

        // End game
        function endGame() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('game-over').style.display = 'block';
            document.querySelector('h1').style.display = 'block';

            document.getElementById('final-rounds').textContent = roundsPlayed;

            if (competitiveMode) {
                // Competitive mode: show average errors, hide accuracy percentages
                document.getElementById('final-rc-accuracy').parentElement.style.display = 'none';
                document.getElementById('final-tc-accuracy').parentElement.style.display = 'none';
                document.getElementById('final-ob-accuracy-box').style.display = 'none';

                // Show error boxes
                document.getElementById('final-rc-error-box').style.display = 'block';
                document.getElementById('final-tc-error-box').style.display = 'block';

                const avgRcError = roundsPlayed > 0 ? (rcTotalError / roundsPlayed).toFixed(1) : 0;
                document.getElementById('final-rc-error').textContent = avgRcError;

                const avgTcError = roundsPlayed > 0 ? (tcTotalError / roundsPlayed).toFixed(2) : 0;
                document.getElementById('final-tc-error').textContent = avgTcError;

                if (testOptimalBet) {
                    document.getElementById('final-ob-error-box').style.display = 'block';
                    const avgObError = roundsPlayed > 0 ? Math.round(obTotalError / roundsPlayed) : 0;
                    document.getElementById('final-ob-error').textContent = '$' + avgObError.toLocaleString();
                }
            } else {
                // Normal mode: show accuracy percentages, hide error boxes
                document.getElementById('final-rc-accuracy').parentElement.style.display = 'block';
                document.getElementById('final-tc-accuracy').parentElement.style.display = 'block';
                document.getElementById('final-rc-error-box').style.display = 'none';
                document.getElementById('final-tc-error-box').style.display = 'none';
                document.getElementById('final-ob-error-box').style.display = 'none';

                const rcAccuracy = roundsPlayed > 0 ? (rcCorrectGuesses / roundsPlayed * 100).toFixed(0) : 0;
                document.getElementById('final-rc-accuracy').textContent = rcAccuracy + '%';

                const tcAccuracy = roundsPlayed > 0 ? (tcCorrectGuesses / roundsPlayed * 100).toFixed(0) : 0;
                document.getElementById('final-tc-accuracy').textContent = tcAccuracy + '%';

                if (testOptimalBet) {
                    document.getElementById('final-ob-accuracy-box').style.display = 'block';
                    const obAccuracy = roundsPlayed > 0 ? (obCorrectGuesses / roundsPlayed * 100).toFixed(0) : 0;
                    document.getElementById('final-ob-accuracy').textContent = obAccuracy + '%';
                }
            }

            const avgTime = roundsPlayed > 0 ? (totalTime / roundsPlayed).toFixed(1) : 0;
            document.getElementById('final-avg-time').textContent = avgTime + 's';

            document.getElementById('final-bankroll').textContent = '$' + currentBankroll.toLocaleString();
        }

        // Reset game
        function resetGame() {
            deck = [];
            runningCount = 0;
            originalRunningCount = 0;
            cardsLeftSetting = 416;
            bankroll = 50000;
            document.getElementById('cards-left-display').textContent = '416';
            document.getElementById('running-count-display').textContent = '0';
            document.getElementById('true-count-display').textContent = '0.00';
            document.getElementById('bankroll').value = '50000';
            document.getElementById('bankroll-display').textContent = '$50,000';
            document.getElementById('optimal-bet-display').textContent = '$0';

            document.getElementById('start-panel').style.display = 'block';
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('game-over').style.display = 'none';
            document.querySelector('h1').style.display = 'block';
        }

        // Keyboard handler for space, F, P, Q, and Z keys
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('game-screen').style.display === 'block') {
                if (e.code === 'Space' && !isPaused) {
                    e.preventDefault();
                    submitGuess();
                } else if (e.code === 'KeyF') {
                    e.preventDefault();
                    toggleCountingSystem();
                } else if (e.code === 'KeyP') {
                    e.preventDefault();
                    togglePause();
                } else if (e.code === 'KeyQ') {
                    e.preventDefault();
                    quitGame();
                } else if (e.code === 'KeyZ' && competitiveMode) {
                    e.preventDefault();
                    endGame();
                }
            } else if (document.getElementById('game-over').style.display === 'block') {
                if (e.code === 'KeyQ') {
                    e.preventDefault();
                    resetGame();
                }
            }
        });

        // Toggle counting system visibility during game
        function toggleCountingSystem() {
            const system = document.getElementById('counting-system');
            system.classList.toggle('visible');

            // Show/hide OB formula based on testOptimalBet setting
            const obFormula = document.getElementById('ob-formula');
            obFormula.style.display = testOptimalBet ? 'block' : 'none';
        }

        // Toggle pause
        function togglePause() {
            if (hasSubmitted) return; // Don't pause during result display

            isPaused = !isPaused;
            const timerEl = document.getElementById('timer');

            if (isPaused) {
                // Pause the timer
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                pauseStartTime = Date.now();
                timerEl.textContent = 'PAUSED';
                timerEl.className = 'timer';
            } else {
                // Resume the timer
                totalPausedTime += Date.now() - pauseStartTime;
                timerEl.textContent = currentTime;
                updateTimer();
                timerInterval = setInterval(() => {
                    currentTime--;
                    updateTimer();
                    if (currentTime <= 0) {
                        submitGuess(true);
                    }
                }, 1000);
            }
        }

        // Quit game and return to start
        function quitGame() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            isPaused = false;
            resetGame();
        }
    </script>
</body>
</html>
